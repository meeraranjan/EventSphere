{% extends 'base.html' %}
{% block content %}

<div class="container mt-4">
    <div class="row">

        <!-- SIDEBAR (only for group chats) -->
        {% if conversation.participants.count > 2 %}
        <div class="col-md-3 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">

                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="text-uppercase text-muted mb-0">MEMBERS</h6>

                        <!-- Yellow "+" Add Member -->
                        <button class="btn btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#addMemberModal"
                                style="padding: 2px 6px; font-size: 0.8rem; background-color:#F2C94C; border:none; color:black; font-weight:600;">
                            +
                        </button>
                    </div>

                    <hr>

                    {% for item in participants_display %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fa fa-user text-secondary"></i>
                                {{ item.name }}
                            </div>

                            {% if conversation.participants.count == 2 %}
                                <!-- 1v1 editing -->
                                <button class="btn btn-sm"
                                        data-edit-user-id="{{ item.user.id }}"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editNicknameModal"
                                        style="background-color:#6F4E37; color:white; border:none;">
                                    Edit
                                </button>

                            {% else %}
                                <!-- Group: only edit YOURSELF -->
                                {% if item.user == user %}
                                    <button class="btn btn-sm"
                                            data-edit-user-id="{{ item.user.id }}"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editNicknameModal"
                                            style="background-color:#6F4E37; color:white; border:none;">
                                        Edit
                                    </button>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endfor %}

                </div>
            </div>
        </div>
        {% endif %}

        <!-- MAIN CHAT -->
        <div class="{% if conversation.participants.count > 2 %}col-md-9{% else %}col-md-12{% endif %}">

            <!-- Back Button -->
            <a href="{% url 'conversation_list' %}" class="btn btn-outline-secondary mb-3">
                ‚Üê Back to Conversations
            </a>

            <!-- Chat Header -->
            <div class="d-flex align-items-center mb-2">
                <h2 class="mb-0 flex-grow-1">

                    {% if conversation.name %}
                        {{ conversation.name }}
                    {% else %}
                        {% if conversation.participants.count > 2 %}
                            Group Chat
                        {% else %}
                            Chat with {{ others_display.0 }}
                        {% endif %}
                    {% endif %}
                </h2>

                {% if conversation.participants.count == 2 %}
                    <!-- 1v1 rename -->
                    <button class="btn btn-sm ms-3"
                            data-edit-user-id="{{ other_participants.0.id }}"
                            data-bs-toggle="modal"
                            data-bs-target="#editNicknameModal"
                            style="background-color:#6F4E37; color:white; border:none;">
                        Edit Nickname
                    </button>

                {% elif conversation.participants.count > 2 %}
                    <a href="{% url 'rename_group' conversation.id %}"
                       class="btn btn-sm ms-3"
                       style="background-color:#6F4E37; color:white; border:none;">
                        Edit Name
                    </a>
                {% endif %}
            </div>

            {% if conversation.participants.count > 2 %}
                <span class="badge"
                      style="background-color:#6F4E37; color:white; padding:6px 12px; font-size:0.75rem; border-radius:12px;">
                    Group Chat
                </span>

                <div class="text-muted small mb-4">
                    Members:
                    {% for item in participants_display %}
                        {{ item.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </div>
            {% endif %}

            <!-- CHAT MESSAGES -->
            <div class="card shadow-sm mb-4" style="height:350px; overflow-y:auto;">
                <div class="card-body">

                    {% if messages_display %}
                        {% for item in messages_display %}
                            {% with msg=item.msg %}
                            <div class="mb-3">

                                {% if item.is_me %}
                                    <div class="text-end">
                                        <div class="d-inline-block px-3 py-2 rounded"
                                             style="max-width:75%; background-color:#d1e7dd;">
                                            <strong>{{ item.name }}</strong><br>
                                            {{ msg.text }}
                                        </div>
                                    </div>
                                    <div class="small text-muted text-end">
                                        {{ msg.timestamp|date:"M. d, Y g:i a" }}
                                    </div>
                                {% else %}
                                    <div class="text-start">
                                        <div class="d-inline-block px-3 py-2 rounded"
                                             style="max-width:75%; background-color:#f8f9fa;">
                                            <strong>{{ item.name }}</strong><br>
                                            {{ msg.text }}
                                        </div>
                                    </div>
                                    <div class="small text-muted text-start">
                                        {{ msg.timestamp|date:"M. d, Y g:i a" }}
                                    </div>
                                {% endif %}
                            </div>
                            {% endwith %}
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No messages yet. Start the conversation below.</p>
                    {% endif %}

                </div>
            </div>

            <!-- MESSAGE INPUT -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}
                        <div class="input-group">

                            <input type="text" name="text" class="form-control"
                                   placeholder="Type your message..." required>

                            <button class="btn"
                                    type="submit"
                                    style="background-color:#6F4E37; color:white; border:none;">
                                Send
                            </button>

                        </div>
                    </form>
                </div>
            </div>

        </div> <!-- END MAIN CHAT -->

    </div>
</div>

<!-- ADD MEMBER MODAL -->
<div class="modal fade" id="addMemberModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <form method="POST" action="{% url 'add_to_group' conversation.id %}">
                {% csrf_token %}

                <div class="modal-header">
                    <h5 class="modal-title">Add Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    {% if add_member_error %}
                        <div class="alert alert-danger py-2">
                            {{ add_member_error }}
                        </div>
                    {% endif %}

                    <label class="form-label">Enter Username</label>
                    <input type="text" name="username" class="form-control" placeholder="username">
                </div>

                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal">Cancel</button>

                    <button type="submit"
                            class="btn"
                            style="background-color:#6F4E37; color:white; border:none;">
                        Add
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- NICKNAME MODAL -->
<div class="modal fade" id="editNicknameModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form method="POST"
              action="{% url 'update_nickname' conversation.id %}"
              class="modal-content">
            {% csrf_token %}

            <div class="modal-header">
                <h5 class="modal-title">Edit Nickname</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" name="target_user_id" id="nickname-target-user">

                <label class="form-label">Nickname</label>
                <input type="text" name="nickname" class="form-control" id="nickname-input">
            </div>

            <div class="modal-footer">
                <button type="submit"
                        class="btn"
                        style="background-color:#6F4E37; color:white; border:none;">
                    Save
                </button>
            </div>

        </form>
    </div>
</div>

<!-- NICKNAME JS -->
<script>
document.addEventListener('click', function(e) {
    if (e.target.matches('[data-edit-user-id]')) {

        const userId = e.target.getAttribute('data-edit-user-id');
        document.getElementById('nickname-target-user').value = userId;

        let nameDiv = e.target.closest('.d-flex').querySelector('div:first-child');
        let text = "";

        nameDiv.childNodes.forEach(node => {
            if (node.nodeType === Node.TEXT_NODE)
                text += node.textContent;
        });

        document.getElementById('nickname-input').value = text.trim();

        new bootstrap.Modal(document.getElementById("editNicknameModal")).show();
    }
});
</script>

<!-- AUTO-OPEN ADD MEMBER MODAL ON ERROR -->
{% if add_member_error %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const modalEl = document.getElementById("addMemberModal");
    if (modalEl) {
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        const input = modalEl.querySelector('input[name="username"]');
        if (input) input.focus();
    }
});
</script>
{% endif %}

{% endblock %}
